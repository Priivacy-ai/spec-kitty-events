# Implementation Plan: Event Contract Conformance Suite

**Branch**: `005-event-contract-conformance-suite` | **Date**: 2026-02-12 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `kitty-specs/005-event-contract-conformance-suite/spec.md`

## Summary

Finalize the `spec-kitty-events` package as the single source of truth for the Spec Kitty 2.x event contract. This involves four deliverables:

1. **Lane Mapping Contract** — `SyncLaneV1` enum, `CANONICAL_TO_SYNC_V1` mapping, `canonical_to_sync_v1()` function, all locked and immutable for V1.
2. **JSON Schema Artifacts** — Build-time generated `.schema.json` files from Pydantic v2 models, committed to repo, with CI drift detection.
3. **Conformance Suite** — Dual-layer validator (Pydantic-first + JSON Schema secondary), canonical fixtures with manifest, pytest `--pyargs` entry point.
4. **Version Graduation** — `0.4.0-alpha` → `2.0.0-rc1` → `2.0.0`, with compatibility table, changelog, and migration notes.

## Technical Context

**Language/Version**: Python >=3.10 (development on 3.11, mypy target 3.10)
**Primary Dependencies**: Pydantic >=2.0.0,<3.0.0; python-ulid >=1.1.0; jsonschema >=4.21.0,<5.0.0 (optional via `[conformance]`)
**Storage**: N/A (pure library, no persistence)
**Testing**: pytest + pytest-cov + hypothesis; mypy --strict
**Target Platform**: PyPI package, consumed by spec-kitty CLI and spec-kitty-saas
**Project Type**: Single Python package (src layout)
**Performance Goals**: N/A (CI-time validation, not hot path)
**Constraints**: mypy --strict, 98%+ coverage, Python 3.10+ compatibility
**Scale/Scope**: ~11 JSON Schema files, ~20 fixture files, ~3 new modules, ~15 new exports

## Constitution Check

*No constitution file found. Gate skipped.*

## Project Structure

### Documentation (this feature)

```
kitty-specs/005-event-contract-conformance-suite/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 research findings
├── data-model.md        # Entity definitions and relationships
├── quickstart.md        # Developer quickstart guide
├── contracts/
│   ├── lane-mapping-api.md       # Lane mapping contract (locked V1)
│   ├── conformance-api.md        # Validator and fixture loading API
│   └── schema-generation-api.md  # Schema generation and drift check
├── checklists/
│   └── requirements.md           # Spec quality checklist
└── tasks.md             # Work packages (generated by /spec-kitty.tasks)
```

### Source Code (repository root)

```
src/spec_kitty_events/
├── __init__.py                    # Extended with ~10 new exports
├── models.py                      # Existing (unchanged)
├── status.py                      # Extended: SyncLaneV1, CANONICAL_TO_SYNC_V1, canonical_to_sync_v1()
├── lifecycle.py                   # Existing (unchanged)
├── gates.py                       # Existing (unchanged)
├── schemas/                       # NEW: JSON Schema artifacts
│   ├── __init__.py                # load_schema(), schema_path(), list_schemas()
│   ├── generate.py                # Build-time generation + --check drift detection
│   ├── event.schema.json
│   ├── status_transition_payload.schema.json
│   ├── gate_passed_payload.schema.json
│   ├── gate_failed_payload.schema.json
│   ├── mission_started_payload.schema.json
│   ├── mission_completed_payload.schema.json
│   ├── mission_cancelled_payload.schema.json
│   ├── phase_entered_payload.schema.json
│   ├── review_rollback_payload.schema.json
│   ├── lane.schema.json
│   └── sync_lane_v1.schema.json
├── conformance/                   # NEW: Conformance suite
│   ├── __init__.py                # Public API: validate_event(), load_fixtures()
│   ├── validators.py              # ConformanceResult, ModelViolation, SchemaViolation
│   ├── pytest_helpers.py          # Reusable test utilities for consumers
│   ├── test_pyargs_entrypoint.py  # pytest --pyargs entry point
│   ├── conftest.py                # Shared pytest fixtures
│   └── fixtures/
│       ├── manifest.json          # Fixture expectations (id, path, expected_result, notes, min_version)
│       ├── events/
│       │   ├── valid/             # Valid event payloads for all event types
│       │   └── invalid/           # Invalid payloads (missing fields, wrong types, etc.)
│       ├── lane_mapping/
│       │   ├── valid/             # All 7 canonical → sync mappings
│       │   └── invalid/           # Invalid lane values
│       └── edge_cases/
│           ├── valid/             # Alias normalization, optional field omission
│           └── invalid/           # Schema version mismatch, etc.

tests/
├── unit/
│   ├── test_sync_lane.py          # NEW: SyncLaneV1 + mapping tests
│   ├── test_schemas.py            # NEW: Schema generation + loading tests
│   └── test_conformance.py        # NEW: Validator unit tests
├── property/
│   └── test_lane_mapping_determinism.py  # NEW: Property tests for mapping
└── integration/
    └── test_schema_drift.py       # NEW: Schema drift detection integration test
```

**Structure Decision**: Single Python package with `src/` layout (existing). Two new subpackages (`schemas/` and `conformance/`) added under the main package. No new top-level directories.

## Engineering Decisions

### ED-1: Build-Time Schema Generation

Schemas are generated by a script (`python -m spec_kitty_events.schemas.generate`) and committed. CI runs `--check` mode to detect drift. Committed files are the contract source of truth for cross-repo consumers.

### ED-2: Dual-Layer Validation

Pydantic `model_validate()` is the primary validator (catches all business rules). JSON Schema validation via `jsonschema` is the secondary drift check. `ConformanceResult` has separate `model_violations` and `schema_violations` buckets with a `schema_check_skipped` flag.

### ED-3: Optional Dependency Strategy

Core package: mapping API + Pydantic validator + fixtures + schema access (zero new deps). `[conformance]` extra: `jsonschema>=4.21.0,<5.0.0`. If `jsonschema` not installed, validator runs Pydantic-only and sets `schema_check_skipped=True`.

### ED-4: Locked V1 Mapping

`SyncLaneV1` and `CANONICAL_TO_SYNC_V1` are immutable. Any change to V1 output for a given input = breaking change (3.0.0). New mapping versions are additive (V2, V3) in 2.x minor releases.

### ED-5: Fixture Manifest

`manifest.json` declares fixture expectations (id, path, expected_result, event_type, notes, min_version). Tests are driven from the manifest — no hardcoded assumptions. Cross-repo CI consumes fixtures consistently via the manifest.

## Risk Handling

### Mixed-Version Deployments

**Risk**: Consumer A on `2.0.0`, Consumer B on `2.1.0` — events have different optional fields.
**Mitigation**: SemVer ensures additive changes only in `2.x`. `SyncLaneV1` mapping is identical across all `2.x` versions. Conformance tests verify backward compatibility.

### Schema Drift During Development

**Risk**: Developer modifies a Pydantic model but forgets to regenerate schemas.
**Mitigation**: CI drift check (`python -m spec_kitty_events.schemas.generate --check`) fails the build. Pre-commit hook optional.

### Pydantic JSON Schema Quirks

**Risk**: `model_json_schema()` output may change between Pydantic minor versions.
**Mitigation**: Pin `pydantic>=2.0.0,<3.0.0`. Schema files are committed — any regeneration diff is visible and reviewable. Conformance tests catch regressions.

### Cross-Repo Adoption Sequencing

**Risk**: CLI and SaaS can't both adopt simultaneously.
**Mitigation**: `2.0.0-rc1` allows parallel validation. Each repo adds conformance CI independently. Promotion to `2.0.0` only after both repos are green.

## Artifacts Generated

| Artifact | Path | Status |
|----------|------|--------|
| Specification | `kitty-specs/005-event-contract-conformance-suite/spec.md` | Complete |
| Research | `kitty-specs/005-event-contract-conformance-suite/research.md` | Complete |
| Data Model | `kitty-specs/005-event-contract-conformance-suite/data-model.md` | Complete |
| Quickstart | `kitty-specs/005-event-contract-conformance-suite/quickstart.md` | Complete |
| Lane Mapping Contract | `kitty-specs/005-event-contract-conformance-suite/contracts/lane-mapping-api.md` | Complete |
| Conformance API Contract | `kitty-specs/005-event-contract-conformance-suite/contracts/conformance-api.md` | Complete |
| Schema Generation Contract | `kitty-specs/005-event-contract-conformance-suite/contracts/schema-generation-api.md` | Complete |
| Quality Checklist | `kitty-specs/005-event-contract-conformance-suite/checklists/requirements.md` | Complete |
