# Implementation Plan: Status State Model Contracts

**Branch**: `main` | **Date**: 2026-02-08 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/kitty-specs/003-status-state-model-contracts/spec.md`

## Summary

Add a new `status.py` module to `spec-kitty-events` that establishes the library as the shared contract authority for feature/WP status lifecycle events. The module provides: a 7-lane enumeration with legacy alias normalization, typed Pydantic v2 payload models for status transitions and done evidence, a transition matrix validator, deterministic sort/dedup primitives, and a pure reference reducer. All additions are backward-compatible with v0.2.0. Release as 0.3.0-alpha.

## Technical Context

**Language/Version**: Python >=3.10 (target 3.10 for compatibility, dev/test on 3.11)
**Primary Dependencies**: pydantic >=2.0.0,<3.0.0; python-ulid >=1.1.0 (no new deps)
**Storage**: N/A (pure logic only, no file I/O)
**Testing**: pytest + hypothesis + mypy --strict
**Target Platform**: Library consumed by CLI (spec-kitty) and SaaS (spec-kitty-saas)
**Project Type**: Single Python library package
**Performance Goals**: N/A (in-memory model operations, not a hot path)
**Constraints**: mypy --strict, Python 3.10 compat, frozen Pydantic models, no new dependencies
**Scale/Scope**: Single module ~400-600 LOC, 21 new exports

## Constitution Check

*No constitution file found. Section skipped.*

## Project Structure

### Documentation (this feature)

```
kitty-specs/003-status-state-model-contracts/
├── meta.json
├── spec.md
├── plan.md              # This file
├── research.md          # Phase 0: design decisions
├── data-model.md        # Phase 1: entity definitions
├── quickstart.md        # Phase 1: usage examples
├── contracts/
│   └── status-api.md    # Phase 1: public API contract
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks/               # Phase 2: work packages (generated by /spec-kitty.tasks)
```

### Source Code (repository root)

```
src/spec_kitty_events/
├── __init__.py          # MODIFIED: add 21 new exports from status.py
├── models.py            # UNCHANGED
├── gates.py             # UNCHANGED
├── status.py            # NEW: all status state model contracts
├── clock.py             # UNCHANGED
├── conflict.py          # UNCHANGED
├── topology.py          # UNCHANGED
├── crdt.py              # UNCHANGED
├── merge.py             # UNCHANGED
├── storage.py           # UNCHANGED
└── error_log.py         # UNCHANGED

tests/
├── unit/
│   ├── test_status.py           # NEW: unit tests for status.py
│   └── (existing tests unchanged)
├── property/
│   ├── test_status_determinism.py  # NEW: property tests for reducer/ordering
│   └── (existing tests unchanged)
└── integration/
    └── (existing tests unchanged)
```

**Structure Decision**: Single new module `status.py` matching the flat pattern established by `gates.py`. All existing modules untouched. Split trigger documented: refactor to `status/` subpackage if file exceeds ~600 LOC or accumulates unrelated domains (API-preserving re-export from `__init__.py`).

## Design Decisions

### D1: Module Organization

Single `status.py` with clearly separated in-file sections:

```python
# === Section 1: Enums (Lane, ExecutionMode) ===
# === Section 2: Evidence Models (RepoEvidence, VerificationEntry, ReviewVerdict, DoneEvidence) ===
# === Section 3: Transition Models (ForceMetadata, StatusTransitionPayload) ===
# === Section 4: Validation (TransitionValidationResult, validate_transition, transition matrix) ===
# === Section 5: Ordering (status_event_sort_key, dedup_events) ===
# === Section 6: Reducer (WPState, TransitionAnomaly, ReducedStatus, reduce_status_events) ===
```

### D2: Lane Enum — (str, Enum) for 3.10 Compat

```python
class Lane(str, Enum):
    PLANNED = "planned"
    CLAIMED = "claimed"
    IN_PROGRESS = "in_progress"
    FOR_REVIEW = "for_review"
    DONE = "done"
    BLOCKED = "blocked"
    CANCELED = "canceled"
```

Alias normalization via standalone `normalize_lane()` function, not a classmethod, so it can raise our custom `ValidationError`.

### D3: Transition Matrix — Data-Driven

```python
_ALLOWED_TRANSITIONS: FrozenSet[Tuple[Optional[Lane], Lane]] = frozenset({
    (None, Lane.PLANNED),
    (Lane.PLANNED, Lane.CLAIMED),
    (Lane.CLAIMED, Lane.IN_PROGRESS),
    (Lane.IN_PROGRESS, Lane.FOR_REVIEW),
    (Lane.FOR_REVIEW, Lane.DONE),
    (Lane.FOR_REVIEW, Lane.IN_PROGRESS),
    (Lane.IN_PROGRESS, Lane.PLANNED),
})

# "any non-terminal -> blocked" and "any non-terminal -> canceled" handled programmatically
# "blocked -> in_progress" as explicit entry
```

This is data-driven, not a chain of if/else. Easy to test exhaustively and extend.

### D4: Validation Returns Results, Not Exceptions

`validate_transition()` returns `TransitionValidationResult(valid, violations)`. Consumers decide whether to raise, log, or continue. The reducer uses it internally to detect anomalies without halting.

### D5: Reducer Pipeline

```
Input: Sequence[Event]
  → filter event_type == "WPStatusChanged"
  → sort by status_event_sort_key
  → dedup by event_id
  → group by (wp_id, lamport_clock) for rollback-aware precedence
  → sequential reduce per WP
  → collect anomalies
Output: ReducedStatus
```

The reducer is a single pure function. No streaming, no callbacks, no I/O.

### D6: Rollback-Aware Precedence

Within each `(wp_id, lamport_clock)` group, if any event is a reviewer rollback (`for_review -> in_progress` with `review_ref`), it is applied last, overriding concurrent forward moves. This implements PRD Section 9.2.

### D7: Version Bump

- `pyproject.toml`: `version = "0.3.0-alpha"`
- `__init__.py`: `__version__ = "0.3.0-alpha"`
- `CHANGELOG.md`: New section with graduation criteria:
  - Stable when: 2+ consumers integrated, all property tests green for 30+ days, no breaking API changes needed

## Complexity Tracking

No constitution violations to justify (no constitution exists).

## Implementation Phases (for task generation)

Phase boundaries for `/spec-kitty.tasks` to split into work packages:

1. **Lane/Evidence Models + Public API** — Lane enum, ExecutionMode, all evidence models, ForceMetadata, StatusTransitionPayload, normalize_lane(), exports, unit tests
2. **Transition Validation** — Transition matrix, validate_transition(), TransitionValidationResult, TransitionError, unit tests covering full matrix
3. **Ordering + Reducer** — status_event_sort_key(), dedup_events(), WPState, TransitionAnomaly, ReducedStatus, reduce_status_events(), unit + property tests
4. **Version Bump + Consumer Docs** — Version 0.3.0-alpha, CHANGELOG, consumer integration checklists, backward compat verification

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| `str, Enum` behaves differently from `StrEnum` in Pydantic v2 validators | Model validation fails for Lane fields | Test Lane round-trip through Pydantic model_validate() early in WP01 |
| Reducer rollback precedence logic is subtle | Wrong state after concurrent events | Property test: generate random concurrent events with rollbacks, verify rollback always wins |
| 600 LOC threshold exceeded | File becomes hard to navigate | Monitor during implementation; if exceeded, refactor is a follow-up, not a blocker |
| Consumers depend on Pydantic ValidationError vs our ValidationError | Confusion about which exception to catch | Document clearly: Pydantic errors for structural issues, our ValidationError for domain issues (unknown lanes) |

## Consumer Integration Checklists

### spec-kitty (CLI)

1. Add `spec-kitty-events>=0.3.0a0` to dependencies
2. Import `Lane, StatusTransitionPayload, validate_transition, reduce_status_events` from `spec_kitty_events`
3. Replace any hardcoded lane strings with `Lane` enum values
4. Replace `doing` with `Lane.IN_PROGRESS` (or rely on `normalize_lane("doing")` during migration)
5. Use `validate_transition()` before `status emit` / `tasks move-task`
6. Use `reduce_status_events()` for `status materialize` implementation
7. Use `DoneEvidence` for `for_review -> done` transitions
8. Use `ExecutionMode` to tag worktree vs direct_repo context

### spec-kitty-saas

1. Add `spec-kitty-events>=0.3.0a0` to dependencies
2. Import status contracts for API payload validation
3. Use `StatusTransitionPayload` as the schema for status update endpoints
4. Use `validate_transition()` server-side before persisting events
5. Use `reduce_status_events()` for dashboard state computation
6. Map existing database lane values through `normalize_lane()` during migration
7. Use `ReducedStatus` as the response schema for feature status API
