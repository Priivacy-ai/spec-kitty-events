# Implementation Plan: Canonical Event Contract Consolidation

**Branch**: `main` | **Date**: 2026-02-09 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/kitty-specs/004-canonical-event-contract/spec.md`

## Summary

Extend `spec-kitty-events` from a WP-level event library to the full lifecycle contract authority for the convergence plan. This involves: (1) extending the Event envelope with correlation_id, schema_version, and data_tier fields, (2) adding typed payload models for all mission-level lifecycle events, (3) implementing a lifecycle reducer that composes with the existing WP status reducer, with explicit precedence rules (cancel > re-open, rollback creates new event, idempotent dedup), and (4) formalizing envelope versioning rules. All additions build on the patterns established by Features 001-003. Release as 0.4.0-alpha.

## Technical Context

**Language/Version**: Python >=3.10 (target 3.10 for compatibility, dev/test on 3.11)
**Primary Dependencies**: pydantic >=2.0.0,<3.0.0; python-ulid >=1.1.0 (no new deps)
**Storage**: N/A (pure logic only, no file I/O)
**Testing**: pytest + hypothesis + mypy --strict
**Target Platform**: Library consumed by CLI (spec-kitty) and SaaS (spec-kitty-saas)
**Project Type**: Single Python library package
**Performance Goals**: N/A (in-memory model operations, not a hot path)
**Constraints**: mypy --strict, Python 3.10 compat, frozen Pydantic models, no new dependencies
**Scale/Scope**: ~300-400 new LOC in lifecycle.py, ~50 LOC modifications to models.py and __init__.py, 15+ new exports

## Constitution Check

*No constitution file found. Section skipped.*

## Project Structure

### Documentation (this feature)

```
kitty-specs/004-canonical-event-contract/
├── meta.json
├── spec.md
├── plan.md              # This file
├── research.md          # Phase 0: design decisions
├── data-model.md        # Phase 1: entity definitions
├── quickstart.md        # Phase 1: usage examples
├── contracts/
│   └── lifecycle-api.md # Phase 1: public API contract
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks/               # Phase 2: work packages (generated by /spec-kitty.tasks)
```

### Source Code (repository root)

```
src/spec_kitty_events/
├── __init__.py          # MODIFIED: add new exports, bump version
├── models.py            # MODIFIED: add correlation_id, schema_version, data_tier to Event
├── lifecycle.py         # NEW: mission lifecycle payload models + reducer
├── gates.py             # UNCHANGED
├── status.py            # UNCHANGED (reducer reused via delegation)
├── clock.py             # UNCHANGED
├── conflict.py          # UNCHANGED
├── topology.py          # UNCHANGED
├── crdt.py              # UNCHANGED
├── merge.py             # UNCHANGED
├── storage.py           # UNCHANGED
└── error_log.py         # UNCHANGED

tests/
├── unit/
│   ├── test_models.py               # MODIFIED: tests for new Event fields
│   ├── test_lifecycle.py            # NEW: unit tests for lifecycle.py
│   └── (existing tests updated for new required fields)
├── property/
│   ├── test_lifecycle_determinism.py # NEW: property tests for lifecycle reducer
│   └── (existing tests unchanged)
└── integration/
    ├── test_lifecycle_replay.py      # NEW: projection replay tests
    └── (existing tests updated for new required fields)
```

**Structure Decision**: New `lifecycle.py` module matching the flat pattern established by `gates.py` and `status.py`. Event model extension in existing `models.py`. Existing `status.py` reducer reused by delegation (not duplicated). Split trigger: refactor to `lifecycle/` subpackage if file exceeds ~600 LOC.

## Design Decisions

### D1: Event Envelope Extension Strategy

Add three new fields to the existing `Event` model in `models.py`:

```python
correlation_id: str = Field(
    ...,
    min_length=26,
    max_length=26,
    description="ULID grouping all events in the same mission execution"
)
schema_version: str = Field(
    default="1.0.0",
    pattern=r"^\d+\.\d+\.\d+$",
    description="Envelope schema version (semver)"
)
data_tier: int = Field(
    default=0,
    ge=0,
    le=4,
    description="Progressive data sharing tier (0=local, 4=telemetry)"
)
```

**Breaking change handling**: `correlation_id` is required (no default). All existing test fixtures must be updated to include it. This is acceptable because:
- We control all consumers
- No production event logs exist yet (alpha release)
- The schema_version bump (1.0.0) communicates the change

`schema_version` and `data_tier` have defaults, so they are backward-compatible for deserialization.

### D2: Module Organization — lifecycle.py

New `lifecycle.py` with clearly separated sections:

```python
# === Section 1: Constants (SCHEMA_VERSION, event type strings) ===
# === Section 2: MissionStatus Enum ===
# === Section 3: Lifecycle Payload Models (MissionStarted, Completed, Cancelled, PhaseEntered, ReviewRollback) ===
# === Section 4: Lifecycle Reducer Output Models (ReducedMissionState) ===
# === Section 5: Lifecycle Reducer (reduce_lifecycle_events) ===
```

### D3: Lifecycle Reducer — Composition with Status Reducer

```
Input: Sequence[Event]
  → sort by status_event_sort_key (reuse from status.py)
  → dedup by event_id (reuse from status.py)
  → partition: mission events vs WP events
  → reduce mission events sequentially (MissionStarted → active, PhaseEntered → update phase, MissionCompleted → completed, MissionCancelled → cancelled)
  → delegate WP events to reduce_status_events()
  → merge mission state + WP states
  → apply precedence rules at mission level
  → collect anomalies from both levels
Output: ReducedMissionState
```

### D4: Cancel-Beats-Re-Open Precedence (F-Reducer-001)

Within a group of concurrent events (same Lamport clock) for the same mission:
- If any event is MissionCancelled, it wins over all other mission-level events
- Implementation: after grouping by lamport_clock, sort MissionCancelled events last within the group so they overwrite any concurrent state changes

This mirrors the existing rollback-aware precedence in `status.py` (D6 of Feature 003).

### D5: Rollback Creates New Event (F-Reducer-002)

ReviewRollback is a new event type (not a modification of existing events). The reducer:
1. Processes the ReviewRollback event like any other event
2. Updates the mission's current_phase to the rollback target
3. Does NOT modify or remove previously-processed events
4. The event log remains strictly append-only

### D6: Idempotent Dedup (F-Reducer-003)

Already implemented by `dedup_events()` from Feature 003 — deduplicate by event_id, keeping first occurrence in sorted order. The lifecycle reducer reuses this function directly.

### D7: MissionStatus — (str, Enum) Pattern

```python
class MissionStatus(str, Enum):
    ACTIVE = "active"
    COMPLETED = "completed"
    CANCELLED = "cancelled"
```

Terminal states: {COMPLETED, CANCELLED}. Once a mission reaches a terminal state, further non-anomalous transitions are rejected (anomaly flagged).

### D8: Version Bump

- `pyproject.toml`: `version = "0.4.0-alpha"`
- `__init__.py`: `__version__ = "0.4.0-alpha"`
- SCHEMA_VERSION constant: `"1.0.0"`

## Complexity Tracking

No constitution violations to justify (no constitution exists).

## Implementation Phases (for task generation)

Phase boundaries for `/spec-kitty.tasks` to split into work packages:

1. **Event Envelope Extension + Test Updates** — Add correlation_id, schema_version, data_tier to Event model; add SCHEMA_VERSION constant; update ALL existing tests to supply new required fields; verify round-trip serialization
2. **Lifecycle Payload Models** — MissionStatus enum, MissionStartedPayload, MissionCompletedPayload, MissionCancelledPayload, PhaseEnteredPayload, ReviewRollbackPayload; event type constants; unit tests for construction/validation
3. **Lifecycle Reducer + Precedence Rules** — reduce_lifecycle_events(), ReducedMissionState, cancel-beats-re-open precedence, rollback handling, anomaly detection; unit + property tests; F-Reducer-001, F-Reducer-002, F-Reducer-003
4. **Projection Replay + Version Bump** — Integration tests for projection replay correctness (2E-07, 2E-08); version bump to 0.4.0-alpha; exports in __init__.py; backward compat verification

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Adding required `correlation_id` breaks all existing test fixtures | Tests fail across the board | WP01 dedicated to updating all existing tests; comprehensive grep for Event() construction |
| Lifecycle reducer + status reducer composition creates coupling | Changes in status.py break lifecycle.py | Treat reduce_status_events() as a stable API; lifecycle.py imports only from public API |
| Cancel-beats-re-open precedence may interact with WP-level CANCELED lane | Unexpected double-cancellation behavior | Mission-level cancellation is independent of WP lane. The lifecycle reducer sets mission status; WP lane changes are separate events |
| Property tests with large event sets may be slow | CI timeout | Limit Hypothesis max_examples to 200; use deadline=None for complex strategies |

## Consumer Integration Checklists

### spec-kitty (CLI)

1. Add `spec-kitty-events>=0.4.0a0` to dependencies
2. Import lifecycle types: `MissionStartedPayload, MissionCompletedPayload, PhaseEnteredPayload, MissionCancelledPayload, ReviewRollbackPayload`
3. Import `reduce_lifecycle_events, ReducedMissionState, MissionStatus`
4. Emit lifecycle events with typed payloads instead of raw dicts
5. Include `correlation_id` on all emitted events (one ULID per mission execution)
6. Include `data_tier` on events (default 0 for local-only)
7. Use `reduce_lifecycle_events()` for mission state materialization
8. Pin `SCHEMA_VERSION` and include in emitted event envelopes

### spec-kitty-saas

1. Add `spec-kitty-events>=0.4.0a0` to dependencies
2. Import same lifecycle types as CLI
3. Use lifecycle payload models for API request/response validation
4. Use `reduce_lifecycle_events()` for server-side mission state computation
5. Filter events by `data_tier` for sync scope enforcement
6. Pin same `SCHEMA_VERSION` as CLI
