# Work Packages: Mission Collaboration Soft Coordination Contracts

**Inputs**: Design documents from `kitty-specs/006-mission-collaboration-soft-coordination-contracts/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/collaboration-api.md, quickstart.md

**Tests**: Included — unit tests, property tests, and performance benchmark are explicit deliverables.

**Organization**: 52 subtasks (`T001`–`T052`) roll up into 9 work packages (`WP01`–`WP09`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: Constants and Identity Models (Priority: P0)

**Goal**: Create `src/spec_kitty_events/collaboration.py` with event type constants, `COLLABORATION_EVENT_TYPES` frozenset, and the 3 identity/target models (`ParticipantIdentity`, `AuthPrincipalBinding`, `FocusTarget`) plus `UnknownParticipantError` exception. This is the foundation all subsequent WPs build on.
**Independent Test**: Models can be instantiated, are frozen, pass mypy --strict, and round-trip through `model_dump()` / `model_validate()`.
**Prompt**: `tasks/WP01-constants-and-identity-models.md`
**Estimated prompt size**: ~350 lines

### Included Subtasks
- [x] T001 Create `src/spec_kitty_events/collaboration.py` with module docstring and section headers
- [x] T002 Define 14 event type string constants and `COLLABORATION_EVENT_TYPES` frozenset
- [x] T003 Implement `ParticipantIdentity` frozen Pydantic model
- [x] T004 Implement `AuthPrincipalBinding` frozen Pydantic model
- [x] T005 Implement `FocusTarget` frozen Pydantic model
- [x] T006 Implement `UnknownParticipantError` exception (inherits `SpecKittyEventsError`)
- [x] T007 Write unit tests for all identity models, constants, and exception

### Implementation Notes
- Follow `lifecycle.py` section structure: constants at top, then models, then exception
- `FocusTarget` should remain hashable via Pydantic frozen config (useful for internal reducer indexing and tests)
- `ParticipantIdentity.participant_type` uses `Literal["human", "llm_context"]` but must be typed to allow future extension (use `str` with validator)

### Parallel Opportunities
- T003, T004, T005 can be implemented in parallel (independent models)

### Dependencies
- None (starting package)

### Risks & Mitigations
- FocusTarget hashability: Frozen Pydantic models are hashable by default — verify with test

---

## Work Package WP02: Participant Lifecycle Payloads (Priority: P1)

**Goal**: Add the 4 participant lifecycle payload models: `ParticipantInvitedPayload`, `ParticipantJoinedPayload`, `ParticipantLeftPayload`, `PresenceHeartbeatPayload`. These are the core payloads that establish the mission roster.
**Independent Test**: All 4 payloads can be constructed, are frozen, validate field constraints, and round-trip through JSON.
**Prompt**: `tasks/WP02-participant-lifecycle-payloads.md`
**Estimated prompt size**: ~350 lines

### Included Subtasks
- [x] T008 [P] Implement `ParticipantInvitedPayload` (participant_id, participant_identity, invited_by, mission_id)
- [x] T009 [P] Implement `ParticipantJoinedPayload` (participant_id, participant_identity, mission_id, optional auth_principal_id)
- [x] T010 [P] Implement `ParticipantLeftPayload` (participant_id, mission_id, optional reason)
- [x] T011 [P] Implement `PresenceHeartbeatPayload` (participant_id, mission_id, optional session_id)
- [x] T012 Write unit tests for all 4 lifecycle payloads (valid, invalid, round-trip)

### Implementation Notes
- `ParticipantJoinedPayload.auth_principal_id` is optional (absent for replay/import)
- All payloads include `participant_id` + `mission_id` as required fields
- Follow `MissionStartedPayload` pattern from `lifecycle.py` for frozen model with field descriptions

### Parallel Opportunities
- T008–T011 are fully parallel (independent models in the same file section)

### Dependencies
- Depends on WP01 (ParticipantIdentity model required)

### Risks & Mitigations
- None significant — straightforward Pydantic model definitions

---

## Work Package WP03: Intent, Focus, and Execution Payloads (Priority: P1)

**Goal**: Add the 4 intent/focus/execution payload models: `DriveIntentSetPayload`, `FocusChangedPayload`, `PromptStepExecutionStartedPayload`, `PromptStepExecutionCompletedPayload`.
**Independent Test**: All 4 payloads validate correctly, Literal constraints enforce allowed values, FocusTarget embeds properly.
**Prompt**: `tasks/WP03-intent-focus-execution-payloads.md`
**Estimated prompt size**: ~350 lines

### Included Subtasks
- [x] T013 [P] Implement `DriveIntentSetPayload` (participant_id, mission_id, intent as Literal["active", "inactive"])
- [x] T014 [P] Implement `FocusChangedPayload` (participant_id, mission_id, focus_target as FocusTarget, optional previous_focus_target)
- [x] T015 [P] Implement `PromptStepExecutionStartedPayload` (participant_id, mission_id, step_id, optional wp_id, optional step_description)
- [x] T016 [P] Implement `PromptStepExecutionCompletedPayload` (participant_id, mission_id, step_id, optional wp_id, outcome as Literal)
- [x] T017 Write unit tests for all 4 payloads (valid, invalid, Literal constraints, FocusTarget embedding)

### Implementation Notes
- `FocusChangedPayload.focus_target` embeds `FocusTarget` model (nested Pydantic)
- `PromptStepExecutionCompletedPayload.outcome` is `Literal["success", "failure", "skipped"]`
- Follow pattern from WP02 for consistency

### Parallel Opportunities
- T013–T016 are fully parallel

### Dependencies
- Depends on WP01 (FocusTarget model required)

### Risks & Mitigations
- None significant

---

## Work Package WP04: Warning, Communication, and Session Payloads (Priority: P1)

**Goal**: Add the remaining 6 payload models: `ConcurrentDriverWarningPayload`, `PotentialStepCollisionDetectedPayload`, `WarningAcknowledgedPayload`, `CommentPostedPayload`, `DecisionCapturedPayload`, `SessionLinkedPayload`.
**Independent Test**: All 6 payloads validate correctly. Multi-actor warning payloads enforce `participant_ids: list[str]` with `min_length=2`. Acknowledgement enum is `continue|hold|reassign|defer`.
**Prompt**: `tasks/WP04-warning-communication-session-payloads.md`
**Estimated prompt size**: ~450 lines

### Included Subtasks
- [x] T018 [P] Implement `ConcurrentDriverWarningPayload` (warning_id, mission_id, participant_ids list, focus_target, severity)
- [x] T019 [P] Implement `PotentialStepCollisionDetectedPayload` (warning_id, mission_id, participant_ids list, step_id, optional wp_id, severity)
- [x] T020 [P] Implement `WarningAcknowledgedPayload` (participant_id, mission_id, warning_id, acknowledgement as Literal["continue", "hold", "reassign", "defer"])
- [x] T021 [P] Implement `CommentPostedPayload` (participant_id, mission_id, comment_id, content, optional reply_to)
- [x] T022 [P] Implement `DecisionCapturedPayload` (participant_id, mission_id, decision_id, topic, chosen_option, optional rationale, optional referenced_warning_id)
- [x] T023 [P] Implement `SessionLinkedPayload` (participant_id, mission_id, primary_session_id, linked_session_id, link_type as Literal)
- [x] T024 Write unit tests for all 6 payloads (valid, invalid, min_length constraints on participant_ids, enum validation)

### Implementation Notes
- Warning payloads use `participant_ids: list[str]` (NOT `participant_id`) — this is the multi-actor distinction from FR-003
- `participant_ids` must have `min_length=2` (a warning with only 1 participant is meaningless)
- `WarningAcknowledgedPayload.acknowledgement` uses the `continue|hold|reassign|defer` enum
- `SessionLinkedPayload.link_type` is `Literal["cli_to_saas", "saas_to_cli"]`

### Parallel Opportunities
- T018–T023 are fully parallel (independent models)

### Dependencies
- Depends on WP01 (FocusTarget model for warning payloads)

### Risks & Mitigations
- `participant_ids` min_length validation — test with 1-element list to verify rejection

---

## Work Package WP05: Reducer Output Models (Priority: P1)

**Goal**: Add the reducer output models: `CollaborationAnomaly`, `WarningEntry`, `DecisionEntry`, `CommentEntry`, and `ReducedCollaborationState`. These are the materialized view types returned by the collaboration reducer.
**Independent Test**: All output models can be constructed with representative data, are frozen, and pass mypy --strict.
**Prompt**: `tasks/WP05-reducer-output-models.md`
**Estimated prompt size**: ~350 lines

### Included Subtasks
- [x] T025 Implement `CollaborationAnomaly` frozen model (event_id, event_type, reason)
- [x] T026 [P] Implement `WarningEntry` frozen model (warning_id, event_id, warning_type, participant_ids, acknowledgements dict)
- [x] T027 [P] Implement `DecisionEntry` frozen model (decision_id, event_id, participant_id, topic, chosen_option, optional referenced_warning_id)
- [x] T028 [P] Implement `CommentEntry` frozen model (comment_id, event_id, participant_id, content, optional reply_to)
- [x] T029 Implement `ReducedCollaborationState` frozen model with all fields from data-model.md
- [x] T030 Write unit tests for all output models (construction, freezing, field access)

### Implementation Notes
- `ReducedCollaborationState` is the largest model — 14 fields. Use tuple for ordered collections (warnings, decisions, comments, anomalies) and dict/frozenset for indexed state
- `WarningEntry.acknowledgements` is `dict[str, str]` mapping `participant_id → acknowledgement action`
- Follow `ReducedMissionState` pattern from `lifecycle.py`
- `ReducedCollaborationState.participants_by_focus` uses a normalized string focus key (`"{target_type}:{target_id}"`) for deterministic serialization

### Parallel Opportunities
- T026–T028 are parallel (independent entry models)

### Dependencies
- Depends on WP01 (ParticipantIdentity, FocusTarget, CollaborationAnomaly base types)

### Risks & Mitigations
- Frozen dict/frozenset fields in Pydantic v2: use `ConfigDict(frozen=True)` — verify dict fields work as expected with `model_validate()`

---

## Work Package WP06: Collaboration Reducer (Priority: P1) — MVP

**Goal**: Implement `reduce_collaboration_events()` — the core pure function that processes collaboration events into `ReducedCollaborationState`. Supports strict (default) and permissive modes, with optional seeded roster. This is the heart of the feature.
**Independent Test**: Reducer produces correct state for multi-participant scenarios, raises `UnknownParticipantError` in strict mode for non-rostered participants, handles all 14 event types, is deterministic across orderings.
**Prompt**: `tasks/WP06-collaboration-reducer.md`
**Estimated prompt size**: ~550 lines

### Included Subtasks
- [ ] T031 Implement reducer pipeline skeleton: filter collaboration events → sort (reuse `status_event_sort_key`) → dedup (reuse `dedup_events`) → process loop
- [ ] T032 Implement roster management: process ParticipantJoined/Left, seeded roster pre-loading, membership check helper
- [ ] T033 Implement strict/permissive mode branching: membership validation, UnknownParticipantError raising, anomaly recording
- [ ] T034 Implement event handlers: drive intent, focus tracking, focus reverse index, presence heartbeats, session linking
- [ ] T035 Implement event handlers: warning timeline, acknowledgement tracking, execution start/complete, comments, decisions
- [ ] T036 Implement state assembly: build and return ReducedCollaborationState from accumulated state
- [ ] T037 Write comprehensive unit tests: strict mode (full history + seeded roster + partial window rejection), permissive mode, all 14 event types, edge cases from spec

### Implementation Notes
- Reuse `status_event_sort_key()` and `dedup_events()` from `status.py` — import, don't duplicate
- Reducer signature: `def reduce_collaboration_events(events: Sequence[Event], *, mode: Literal["strict", "permissive"] = "strict", roster: dict[str, ParticipantIdentity] | None = None) -> ReducedCollaborationState`
- Process events sequentially after sort/dedup. For each event: (1) check membership (mode-dependent), (2) dispatch to handler, (3) accumulate state
- All mutable state during reduction is internal; final output is frozen
- Edge cases to handle: duplicate join (anomaly), duplicate leave (anomaly in both modes), idempotent drive intent, heartbeat from departed (strict=error, permissive=anomaly)
- Canonical envelope mapping is a consumer contract, not enforced by reducer (reducer reads payload fields, not envelope)

### Parallel Opportunities
- None — reducer is a single sequential function

### Dependencies
- Depends on WP01 (constants, identity models, exception), WP02–WP04 (all 14 payloads), WP05 (output models)

### Risks & Mitigations
- Reducer complexity: ~200 LOC with clear handler dispatch. Keep handlers as private functions within collaboration.py
- Mode branching: use a helper `_check_membership(participant_id, roster, anomalies, event, mode)` to centralize

---

## Work Package WP07: Exports and Schema Generation (Priority: P1)

**Goal**: Add all 36 new symbols to `__init__.py`, register 17 models in `schemas/generate.py`, generate JSON Schema files, update conformance validators.
**Independent Test**: All symbols importable from `spec_kitty_events`, all 17 JSON schemas generated and valid, schema drift check passes.
**Prompt**: `tasks/WP07-exports-and-schema-generation.md`
**Estimated prompt size**: ~400 lines

### Included Subtasks
- [ ] T038 Add 36 new exports to `src/spec_kitty_events/__init__.py` (organized by category following existing pattern)
- [ ] T039 Register 17 new models in `src/spec_kitty_events/schemas/generate.py` PYDANTIC_MODELS list
- [ ] T040 Run schema generation and commit 17 new `.schema.json` files
- [ ] T041 Update `src/spec_kitty_events/conformance/validators.py` to recognize collaboration payloads
- [ ] T042 Run schema drift check (`python -m spec_kitty_events.schemas.generate --check`) and verify pass

### Implementation Notes
- Export order: constants (15) → identity models (3) → payload models (14) → reducer outputs (3) → reducer function (1) — add as a `# Collaboration` section in `__init__.py`
- Schema generation: import all 14 payloads + 3 identity models, add to PYDANTIC_MODELS as `(snake_case_name, ModelClass)` tuples
- Run `python3.11 -m spec_kitty_events.schemas.generate` to produce JSON files, then `--check` to verify no drift
- Conformance validator: add collaboration payload types to the event_type → model mapping

### Parallel Opportunities
- T038 and T039 are parallel (different files)

### Dependencies
- Depends on WP06 (all models and reducer must exist before exporting)

### Risks & Mitigations
- Import ordering: collaboration.py imports from models.py and status.py; __init__.py imports from collaboration.py — verify no circular imports

---

## Work Package WP08: Conformance Fixtures and Tests (Priority: P2)

**Goal**: Add conformance payload fixtures (5 valid, 2 invalid) compatible with the existing conformance harness, add reducer scenario fixtures for multi-event sequences, and add property tests plus benchmark.
**Independent Test**: Valid conformance fixtures pass dual-layer validation and invalid fixtures fail as expected with current manifest schema; reducer scenario fixtures drive strict/permissive sequence tests; property tests prove determinism across 200+ orderings; benchmark runs under 1s for 10K events.
**Prompt**: `tasks/WP08-conformance-fixtures-and-tests.md`
**Estimated prompt size**: ~500 lines

### Included Subtasks
- [ ] T043 Create `conformance/fixtures/collaboration/valid/` directory and 5 valid **payload** fixture JSON files
- [ ] T044 Create `conformance/fixtures/collaboration/invalid/` directory and 2 invalid **payload** fixture JSON files
- [ ] T045 Register all 7 fixtures in `conformance/fixtures/manifest.json` using current manifest fields (`event_type`, `expected_result`, `min_version`) and include `conformance/fixtures/collaboration/*` in package data
- [ ] T046 Write `tests/property/test_collaboration_determinism.py` — Hypothesis property tests proving reducer determinism across 200+ event orderings (strict and permissive modes)
- [ ] T047 Write `tests/benchmark/test_collaboration_perf.py` — 10K-event synthetic benchmark (50 participants, mixed types), assert <1s, @pytest.mark.benchmark

### Implementation Notes
- Conformance fixture format must match existing harness: one payload object per fixture + manifest `event_type`
- Multi-event collaboration sequences belong in reducer scenario fixtures (outside conformance payload validation), consumed by unit/integration tests
- Keep scenario names for reducer fixtures (3-participant-overlap, step-collision-llm, decision-with-comments, participant-lifecycle, session-linking)
- Property tests: generate random collaboration event sequences, reduce in two orderings, assert same output
- Benchmark: synthetic stream with realistic event type distribution, seeded roster, wall-clock assertion

### Parallel Opportunities
- T043/T044 (fixtures) and T046/T047 (tests) can proceed in parallel

### Dependencies
- Depends on WP07 (schemas and validators must exist for dual-layer validation)

### Risks & Mitigations
- Hypothesis strategy complexity: keep event generation simple — random participant_ids from a small pool, random event types, random clocks
- Benchmark stability: run benchmark marker separately from default suite (`-m benchmark`), keep default regression suite `-m "not benchmark"`

---

## Work Package WP09: Documentation and Version Update (Priority: P2)

**Goal**: Update README, COMPATIBILITY.md, and CHANGELOG with collaboration event reference, reducer contract (strict/permissive), envelope mapping, SaaS-authoritative model, and consumer integration guidance.
**Independent Test**: Documentation is accurate, all 14 event types are listed with field references, and quickstart examples work.
**Prompt**: `tasks/WP09-documentation-and-version-update.md`
**Estimated prompt size**: ~350 lines

### Included Subtasks
- [ ] T048 Update README.md: add Collaboration section listing all 14 event types and key exports
- [ ] T049 Update COMPATIBILITY.md: add collaboration event field reference table, reducer strict/permissive mode contract, canonical envelope mapping (aggregate_id = "mission/{id}", correlation_id = ULID-26), SaaS-authoritative participation model
- [ ] T050 Update CHANGELOG.md: add 2.1.0 entry documenting all collaboration additions
- [ ] T051 Verify quickstart.md examples compile (construct events, reduce, read state)
- [ ] T052 Run full test suite (`python3.11 -m pytest -x -m "not benchmark"`) plus benchmark (`python3.11 -m pytest -m benchmark`) and mypy (`mypy --strict`) to verify package integrity

### Implementation Notes
- Follow existing README/COMPATIBILITY patterns from Feature 005
- Changelog: list all 14 new event types, reducer function, 3 identity models, strict/permissive modes, 36 new exports
- Version: this feature targets 2.1.0 — update `pyproject.toml` version if not already done

### Parallel Opportunities
- T048, T049, T050 can proceed in parallel (different files)

### Dependencies
- Depends on WP08 (all tests and fixtures must pass before documentation can claim coverage/conformance)

### Risks & Mitigations
- Documentation drift: verify all 14 event types match code by cross-referencing `COLLABORATION_EVENT_TYPES`

---

## Dependency & Execution Summary

```
WP01 (Constants & Identity Models)
  ├── WP02 (Participant Lifecycle Payloads) ──┐
  ├── WP03 (Intent/Focus/Execution Payloads) ─┤── can run in parallel
  ├── WP04 (Warning/Comm/Session Payloads) ───┘
  └── WP05 (Reducer Output Models) ───────────┐
                                               ├── WP06 (Collaboration Reducer)
  WP02 + WP03 + WP04 ─────────────────────────┘
                                                    │
                                               WP07 (Exports & Schema Gen)
                                                    │
                                               WP08 (Conformance & Tests)
                                                    │
                                               WP09 (Documentation)
```

- **Sequence**: WP01 → (WP02 ∥ WP03 ∥ WP04 ∥ WP05) → WP06 → WP07 → WP08 → WP09
- **Parallelization**: WP02, WP03, WP04, and WP05 are fully parallel after WP01 completes
- **MVP Scope**: WP01–WP06 deliver the collaboration module with reducer. WP07 makes it importable. WP08–WP09 are polish.

---

## Subtask Index (Reference)

| Subtask | Summary | WP | Priority | Parallel? |
|---------|---------|-----|----------|-----------|
| T001 | Create collaboration.py with module structure | WP01 | P0 | No |
| T002 | Define 14 event type constants + frozenset | WP01 | P0 | No |
| T003 | Implement ParticipantIdentity model | WP01 | P0 | Yes |
| T004 | Implement AuthPrincipalBinding model | WP01 | P0 | Yes |
| T005 | Implement FocusTarget model (hashable) | WP01 | P0 | Yes |
| T006 | Implement UnknownParticipantError exception | WP01 | P0 | Yes |
| T007 | Unit tests for identity models + constants | WP01 | P0 | No |
| T008 | Implement ParticipantInvitedPayload | WP02 | P1 | Yes |
| T009 | Implement ParticipantJoinedPayload | WP02 | P1 | Yes |
| T010 | Implement ParticipantLeftPayload | WP02 | P1 | Yes |
| T011 | Implement PresenceHeartbeatPayload | WP02 | P1 | Yes |
| T012 | Unit tests for lifecycle payloads | WP02 | P1 | No |
| T013 | Implement DriveIntentSetPayload | WP03 | P1 | Yes |
| T014 | Implement FocusChangedPayload | WP03 | P1 | Yes |
| T015 | Implement PromptStepExecutionStartedPayload | WP03 | P1 | Yes |
| T016 | Implement PromptStepExecutionCompletedPayload | WP03 | P1 | Yes |
| T017 | Unit tests for intent/focus/execution payloads | WP03 | P1 | No |
| T018 | Implement ConcurrentDriverWarningPayload | WP04 | P1 | Yes |
| T019 | Implement PotentialStepCollisionDetectedPayload | WP04 | P1 | Yes |
| T020 | Implement WarningAcknowledgedPayload | WP04 | P1 | Yes |
| T021 | Implement CommentPostedPayload | WP04 | P1 | Yes |
| T022 | Implement DecisionCapturedPayload | WP04 | P1 | Yes |
| T023 | Implement SessionLinkedPayload | WP04 | P1 | Yes |
| T024 | Unit tests for warning/comm/session payloads | WP04 | P1 | No |
| T025 | Implement CollaborationAnomaly model | WP05 | P1 | No |
| T026 | Implement WarningEntry model | WP05 | P1 | Yes |
| T027 | Implement DecisionEntry model | WP05 | P1 | Yes |
| T028 | Implement CommentEntry model | WP05 | P1 | Yes |
| T029 | Implement ReducedCollaborationState model | WP05 | P1 | No |
| T030 | Unit tests for output models | WP05 | P1 | No |
| T031 | Reducer pipeline skeleton (filter, sort, dedup) | WP06 | P1 | No |
| T032 | Roster management (join, leave, seeded roster) | WP06 | P1 | No |
| T033 | Strict/permissive mode branching | WP06 | P1 | No |
| T034 | Event handlers: intent, focus, presence, sessions | WP06 | P1 | No |
| T035 | Event handlers: warnings, acks, executions, comments, decisions | WP06 | P1 | No |
| T036 | State assembly into ReducedCollaborationState | WP06 | P1 | No |
| T037 | Comprehensive reducer unit tests | WP06 | P1 | No |
| T038 | Add 36 exports to __init__.py | WP07 | P1 | Yes |
| T039 | Register 17 models in schemas/generate.py | WP07 | P1 | Yes |
| T040 | Generate and commit 17 JSON schema files | WP07 | P1 | No |
| T041 | Update conformance validators | WP07 | P1 | No |
| T042 | Run schema drift check | WP07 | P1 | No |
| T043 | Create 5 valid conformance payload fixtures | WP08 | P2 | Yes |
| T044 | Create 2 invalid conformance payload fixtures | WP08 | P2 | Yes |
| T045 | Register fixtures + package-data paths | WP08 | P2 | No |
| T046 | Property tests for reducer determinism | WP08 | P2 | Yes |
| T047 | Performance benchmark (10K events) | WP08 | P2 | Yes |
| T048 | Update README.md with collaboration section | WP09 | P2 | Yes |
| T049 | Update COMPATIBILITY.md with event reference | WP09 | P2 | Yes |
| T050 | Update CHANGELOG.md for 2.1.0 | WP09 | P2 | Yes |
| T051 | Verify quickstart examples compile | WP09 | P2 | No |
| T052 | Run full test suite and mypy verification | WP09 | P2 | No |
